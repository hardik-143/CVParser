<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF NLP Data Extractor</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Libraries -->
  <script src="https://unpkg.com/compromise"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>
</head>

<body class="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-2xl p-8">

    <h1 class="text-4xl font-bold text-gray-800 mb-2">
      ðŸ“„ PDF NLP Data Extractor
    </h1>
    <p class="text-gray-600 mb-6">
      Extract â†’ Analyze â†’ Search
    </p>

    <!-- Upload -->
    <input id="fileInput" type="file" accept="application/pdf" class="hidden" />
    <div id="uploadBox"
      class="border-4 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer bg-gray-50 hover:bg-gray-100">
      <p class="font-semibold text-lg text-gray-700">Click to upload PDF</p>
    </div>

    <!-- Buttons -->
    <div class="flex gap-3 mt-6">
      <button id="extractBtn" class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold">
        1. Extract Text
      </button>

      <button id="analyzeBtn" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold opacity-50" disabled>
        2. Analyze Text
      </button>
    </div>

    <!-- Search -->
    <input id="searchInput" type="text"
      class="w-full mt-6 p-3 border-2 rounded-lg hidden"
      placeholder="Search extracted content..." />

    <!-- Results -->
    <div id="results" class="mt-6 space-y-3"></div>

    <!-- Output -->
    <pre id="output" class="mt-6 bg-gray-100 p-4 rounded-lg text-sm overflow-auto max-h-96 hidden"></pre>
  </div>

<script>
  let file = null;
  let rawText = "";
  let structuredData = null;
  let fuse = null;

  const fileInput = document.getElementById("fileInput");
  const uploadBox = document.getElementById("uploadBox");
  const extractBtn = document.getElementById("extractBtn");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const searchInput = document.getElementById("searchInput");
  const output = document.getElementById("output");
  const results = document.getElementById("results");
  let numPages = 0;

  // Status banner
  const statusBar = document.createElement("div");
  statusBar.id = "statusBar";
  statusBar.className = "mt-4 text-sm hidden";
  document.querySelector(".max-w-6xl").appendChild(statusBar);

  function setStatus(msg, type = "info") {
    statusBar.textContent = msg;
    statusBar.classList.remove("hidden", "text-gray-600", "text-green-600", "text-red-600");
    const map = { info: "text-gray-600", success: "text-green-600", error: "text-red-600" };
    statusBar.classList.add(map[type] || map.info);
  }

  uploadBox.onclick = () => fileInput.click();
  uploadBox.addEventListener("dragover", e => { e.preventDefault(); uploadBox.classList.add("bg-gray-100"); });
  uploadBox.addEventListener("dragleave", () => uploadBox.classList.remove("bg-gray-100"));
  uploadBox.addEventListener("drop", e => {
    e.preventDefault();
    const dropped = e.dataTransfer.files[0];
    if (dropped && dropped.type === "application/pdf") {
      fileInput.files = e.dataTransfer.files;
      file = dropped;
      uploadBox.innerHTML = `<p class="font-semibold">${file.name}</p>`;
      uploadBox.classList.remove("bg-gray-100");
    } else {
      setStatus("Please drop a PDF file.", "error");
    }
  });

  fileInput.onchange = e => {
    file = e.target.files[0];
    uploadBox.innerHTML = `<p class="font-semibold">${file.name}</p>`;
  };

  extractBtn.onclick = async () => {
    if (!file) return alert("Upload PDF first");

    setStatus("Extracting textâ€¦", "info");
    extractBtn.disabled = true;
    const prevExtractText = extractBtn.textContent;
    extractBtn.textContent = "Extractingâ€¦";

    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
    numPages = pdf.numPages;

    rawText = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      rawText += content.items.map(i => i.str).join(" ") + "\n\n";
    }

    analyzeBtn.disabled = false;
    analyzeBtn.classList.remove("opacity-50");
    output.classList.remove("hidden");
    output.textContent = rawText.slice(0, 2000) + "...";
    setStatus("Text extracted. Click Analyze to continue.", "success");
    extractBtn.disabled = false;
    extractBtn.textContent = prevExtractText;
  };

  function renderResults(items) {
    results.innerHTML = "";
    if (!items || items.length === 0) {
      results.innerHTML = `<div class="text-gray-600">No results found.</div>`;
      return;
    }
    for (const item of items) {
      const details = item.details ? JSON.stringify(item.details, null, 2) : null;
      const card = document.createElement("div");
      card.className = "p-4 border rounded-lg bg-white shadow-sm";
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">${item.type}</span>
          <span class="text-xs text-gray-500">Confidence: ${(item.confidence ?? 0).toFixed(2)}</span>
        </div>
        <div class="mt-2 text-sm text-gray-800"><span class="font-semibold">${item.field}:</span> ${item.value ?? ""}</div>
        ${details ? `<pre class="mt-2 text-xs bg-gray-50 p-2 rounded">${details}</pre>` : ""}
      `;
      results.appendChild(card);
    }
  }

  analyzeBtn.onclick = async () => {
    if (!rawText || rawText.length < 20) {
      alert("Extract text first");
      return;
    }

    analyzeBtn.disabled = true;
    analyzeBtn.classList.add("opacity-50");
    const prevAnalyzeText = analyzeBtn.textContent;
    analyzeBtn.textContent = "Analyzingâ€¦";
    setStatus("Analyzing extracted textâ€¦", "info");

    try {
      const resp = await fetch("http://127.0.0.1:8000/parse-extracted-cv", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          raw_text: rawText,
          page_texts: [],
          num_pages: numPages || 1,
          basic_info: null,
          sections: {},
          entities: null,
          file_name: file ? file.name : "uploaded.pdf"
        })
      });

      if (!resp.ok) {
        const msg = await resp.text();
        throw new Error(`Server error (${resp.status}): ${msg}`);
      }

      const data = await resp.json();
      structuredData = data?.data || [];

      // Show search and render
      searchInput.classList.remove("hidden");
      renderResults(structuredData);

      // Setup Fuse for fuzzy search
      fuse = new Fuse(structuredData, {
        includeScore: true,
        threshold: 0.3,
        keys: [
          "type",
          "field",
          "value",
          "details.company",
          "details.institution",
          "details.field",
          "details.year",
          "details.duration",
          "details.description"
        ]
      });

      searchInput.oninput = () => {
        const q = searchInput.value.trim();
        if (!q) {
          renderResults(structuredData);
          return;
        }
        const res = fuse.search(q).map(r => r.item);
        renderResults(res);
      };

    } catch (err) {
      console.error(err);
      setStatus(`Failed to analyze: ${err.message}`, "error");
    } finally {
      analyzeBtn.disabled = false;
      analyzeBtn.classList.remove("opacity-50");
      analyzeBtn.textContent = prevAnalyzeText;
      if (structuredData && structuredData.length) setStatus("Analysis complete.", "success");
    }
  };

</script>
</body>
</html>
